<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics and Reports - BizBot Admin</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Include Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
</head>

<body>
    <div class="container">
<aside class="sidebar">
    <h2>BizBot Admin</h2>
    <nav>
        <ul>
            <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="chatbot-management.html"><i class="fas fa-robot"></i> Chatbot Management</a></li>
            <li><a href="training.html"><i class="fas fa-database"></i> Training Data</a></li>
            <li><a href="integration.html"><i class="fas fa-plug"></i> Integration</a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> Chatbot Customization</a></li>
            <li><a href="analytics.html" class="active"><i class="fas fa-chart-line"></i> Analytics</a></li>
            <li><button class="btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button></li>
        </ul>
    </nav>
</aside>
        <main class="main-content">
            <header class="dashboard-header">
                <h1>Analytics and Reports</h1>
            </header>

            <!-- Dropdown to choose a chatbot -->
            <div class="card">
                <h2>Choose a Chatbot</h2>
                <select id="chatbotSelector">
                    <!-- Options will be populated dynamically -->
                </select>
            </div>

            <div class="card">
                <h2>Choose Data Type</h2>
                <select id="dataSelector">
                    <option value="ratings">Ratings</option>
                    <option value="messages">Messages Interactions</option>
                </select>
            </div>

            <!-- Dropdown to choose chart type -->
            <div class="card">
                <h2>Choose a Chart</h2>
                <select id="chartSelector">
                    <option value="bar">Bar Chart</option>
                    <option value="line">Line Chart</option>
                    <option value="pie">Pie Chart</option>
                </select>
            </div>

            <div class="card">
                <button id="downloadCsv" class="btn">Download CSV</button>
                <button id="downloadPdf" class="btn">Download PDF</button>
            </div>


            <!-- Bar Chart Section -->
            <div class="card" id="barChartContainer" style="display: block;">
                <h2>Chatbot Rating (Bar Chart)</h2>
                <canvas id="barChart"></canvas>
            </div>

            <!-- Line Chart Section -->
            <div class="card" id="lineChartContainer" style="display: none;">
                <h2>Chatbot Rating (Line Chart)</h2>
                <canvas id="lineChart"></canvas>
            </div>

            <!-- Pie Chart Section -->
            <div class="card" id="pieChartContainer" style="display: none;">
                <h2>Chatbot Rating (Pie Chart)</h2>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>

            <!-- Dropdown to choose the period (Daily, Weekly, Monthly) -->
            <div class="card">
                <h2>Choose Time Period</h2>
                <select id="timePeriodSelector">
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                </select>
            </div>


        </main>
    </div>
    <script src="https://bizbot-khpq.onrender.com/widget.js" id="bizbot-widget" data-chatbot-id="67595a851ded2dd74d13aa5e" data-user-id="6759576bdec096fe08ac3f07" data-token="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjaGF0Ym90SWQiOiI2NzU5NWE4NTFkZWQyZGQ3NGQxM2FhNWUiLCJ1c2VySWQiOiI2NzU5NTc2YmRlYzA5NmZlMDhhYzNmMDciLCJpYXQiOjE3MzM5NzUzOTQsImV4cCI6MTczNDA2MTc5NH0.hBYDtCrqErLRN_Y7NGgg2qo5_rqhml7UcHBHGyJ1GkM"></script>
    <script src="app.js"></script>
    <script>
        // Initialize Chart.js context
        let barChart, lineChart, pieChart;
        const barChartCtx = document.getElementById('barChart').getContext('2d');
        const lineChartCtx = document.getElementById('lineChart').getContext('2d');
        const pieChartCtx = document.getElementById('pieChart').getContext('2d');

        // Function to create and return a new chart instance
        function createChart(ctx, type) {
            return new Chart(ctx, {
                type: type,
                data: {
                    labels: ['Poor', 'Unsatisfied', 'Neutral', 'Satisfied', 'Excellent'],
                    datasets: [{
                        label: 'Ratings',
                        data: [0, 0, 0, 0, 0],  // Initial data (to be updated)
                        backgroundColor: ['#ff0000', '#ff9900', '#ffff00', '#33cc33', '#3399ff'],
                        borderColor: '#333',
                        borderWidth: 1
                    }]
                }
            });
        }

        // Create chart instances on page load
        barChart = createChart(barChartCtx, 'bar');
        lineChart = createChart(lineChartCtx, 'line');
        pieChart = createChart(pieChartCtx, 'pie');

async function fetchChatbots() {
    const token = localStorage.getItem('token');
    try {
        const response = await fetch('/api/chatbots', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to load chatbots');

        const chatbots = await response.json();
        const chatbotSelector = document.getElementById('chatbotSelector');
        chatbotSelector.innerHTML = '';  // Clear previous options

        if (chatbots.length > 0) {
            chatbots.forEach((chatbot, index) => {
                const option = document.createElement('option');
                option.value = chatbot._id;
                option.textContent = chatbot.name;
                chatbotSelector.appendChild(option);
                if (index === 0) {
                    chatbotSelector.value = chatbot._id; // Set the first chatbot as selected
                    updateCharts(chatbot._id, 'messages', 'daily'); // Update charts for the first chatbot with the daily period
                }
            });
        } else {
            chatbotSelector.innerHTML = '<option>No chatbots available</option>';
            clearCharts();
        }
    } catch (error) {
        console.error('Error fetching chatbots:', error);
        chatbotSelector.innerHTML = '<option>Error loading chatbots</option>';
        clearCharts();
    }
}

// Function to clear charts or handle empty data scenarios
function clearCharts() {
    const datasets = [barChart, lineChart, pieChart].map(chart => chart.data.datasets[0].data);
    datasets.forEach(data => data.fill(0)); // Set all data to zero
    [barChart, lineChart, pieChart].forEach(chart => chart.update());
}

// Call fetchChatbots to initialize everything
document.addEventListener('DOMContentLoaded', fetchChatbots);


        // Fetch ratings for the selected chatbot
async function fetchRatings(chatbotId) {
    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`/api/chatbots/ratings/${chatbotId}`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            return await response.json();
        } else {
            throw new Error('Failed to fetch ratings');
        }
    } catch (error) {
        console.error('Error fetching ratings:', error);
        // Return default values if the fetch fails
        return [];
    }
}

// Fetch messages sent by the user for a specific chatbot
async function fetchMessages(chatbotId) {
    const token = localStorage.getItem('token');
    try {
        const response = await fetch(`/api/message/${chatbotId}`, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            return await response.json(); // Returns an array of messages
        } else {
            throw new Error('Failed to fetch messages');
        }
    } catch (error) {
        console.error('Error fetching messages:', error);
        return [];
    }
}



// Event listener for time period selection (Daily, Weekly, Monthly)
document.getElementById('timePeriodSelector').addEventListener('change', function () {
    const selectedTimePeriod = this.value;
    const selectedChatbotId = document.getElementById('chatbotSelector').value;
    if (selectedChatbotId) {
        updateCharts(selectedChatbotId, 'messages', selectedTimePeriod);
    }
});

// Update the charts with new ratings or messages data
async function updateCharts(selectedChatbotId, dataType, timePeriod = 'daily') {
    if (dataType === 'ratings') {
        // Fetch ratings for all chatbots and compare
        const ratings = await fetchAllChatbotsRatings();
        const selectedChatbotRatings = ratings.find(rating => rating.chatbotId === selectedChatbotId);
        const otherChatbotsRatings = ratings.filter(rating => rating.chatbotId !== selectedChatbotId);

        // Prepare the ratings data for the selected chatbot and others
        const data = prepareRatingsData(selectedChatbotRatings, otherChatbotsRatings);

        // Update charts for ratings
        updateChart(barChart, data.barData, data.labels);
        updateChart(lineChart, data.lineData, data.labels);
        updateChart(pieChart, data.pieData, data.labels);

        // Show rating charts and hide message charts
        document.getElementById('messagesContainer').style.display = 'none';
        document.getElementById('barChartContainer').style.display = 'block';
        document.getElementById('lineChartContainer').style.display = 'block';
        document.getElementById('pieChartContainer').style.display = 'block';
    } else if (dataType === 'messages') {
        // Fetch all chatbots' message data and compare
        const messages = await fetchAllChatbotsMessages();
        const selectedChatbotMessages = messages.find(msg => msg.chatbotId === selectedChatbotId);
        const otherChatbotsMessages = messages.filter(msg => msg.chatbotId !== selectedChatbotId);

        // Prepare the messages data for the selected chatbot and others
        const data = prepareMessagesData(selectedChatbotMessages, otherChatbotsMessages, timePeriod);

        // Update the charts for message comparisons (total messages)
        updateChart(barChart, data.barData, data.labels);
        updateChart(lineChart, data.lineData, data.labels);
        updateChart(pieChart, data.pieData, data.labels);

        // Show message charts and hide rating charts
        document.getElementById('messagesContainer').style.display = 'block';
        document.getElementById('barChartContainer').style.display = 'none';
        document.getElementById('lineChartContainer').style.display = 'none';
        document.getElementById('pieChartContainer').style.display = 'none';
    }
}

// Fetch all chatbots' ratings data
async function fetchAllChatbotsRatings() {
    const token = localStorage.getItem('token');
    try {
        const response = await fetch('/api/chatbots/ratings', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            return await response.json();
        } else {
            throw new Error('Failed to fetch ratings');
        }
    } catch (error) {
        console.error('Error fetching ratings:', error);
        return [];
    }
}

// Fetch all chatbots' messages data
async function fetchAllChatbotsMessages() {
    const token = localStorage.getItem('token');
    try {
        const response = await fetch('/api/messages', {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        if (response.ok) {
            return await response.json();
        } else {
            throw new Error('Failed to fetch messages');
        }
    } catch (error) {
        console.error('Error fetching messages:', error);
        return [];
    }
}

// Prepare ratings data for selected and other chatbots
function prepareRatingsData(selectedChatbotRatings, otherChatbotsRatings) {
    const labels = ['Poor', 'Unsatisfied', 'Neutral', 'Satisfied', 'Excellent'];
    const selectedData = selectedChatbotRatings ? selectedChatbotRatings.data : [0, 0, 0, 0, 0];
    const otherData = otherChatbotsRatings.map(chatbot => chatbot.data.reduce((acc, count) => acc + count, 0));

    return {
        barData: [selectedData, ...otherData],
        lineData: [selectedData, ...otherData],
        pieData: [selectedData.reduce((a, b) => a + b, 0), ...otherData],
        labels: labels
    };
}

// Prepare message data for selected and other chatbots
function prepareMessagesData(selectedChatbotMessages, otherChatbotsMessages, timePeriod) {
    const labels = [];
    const selectedData = [];
    const otherData = [];

    // Group by time period and count messages
    selectedChatbotMessages.forEach(msg => {
        const periodKey = getTimePeriodKey(msg.createdAt, timePeriod);
        if (!labels.includes(periodKey)) labels.push(periodKey);
        selectedData.push(periodKey);
    });

    otherChatbotsMessages.forEach(msg => {
        const periodKey = getTimePeriodKey(msg.createdAt, timePeriod);
        if (!labels.includes(periodKey)) labels.push(periodKey);
        otherData.push(periodKey);
    });

    return {
        barData: [selectedData.length, otherData.length],
        lineData: selectedData,
        pieData: [selectedData.length, otherData.length],
        labels: labels
    };
}

// Helper function to get the time period key (day, week, or month)
function getTimePeriodKey(createdAt, timePeriod) {
    const messageDate = new Date(createdAt);
    if (timePeriod === 'daily') {
        return messageDate.toLocaleDateString();
    } else if (timePeriod === 'weekly') {
        const weekNumber = Math.ceil((messageDate.getDate() + 1) / 7);
        return `${messageDate.getFullYear()}-W${weekNumber}`;
    } else if (timePeriod === 'monthly') {
        return `${messageDate.getFullYear()}-${messageDate.getMonth() + 1}`;
    }
}



        // Event listener for chatbot selection
document.getElementById('chatbotSelector').addEventListener('change', function () {
    const selectedChatbotId = this.value;
    const selectedDataType = document.getElementById('dataSelector').value;
    if (selectedChatbotId) {
        updateCharts(selectedChatbotId, selectedDataType);
    }
});

// Event listener for data type selection (Ratings or Messages)
document.getElementById('dataSelector').addEventListener('change', function () {
    const selectedDataType = this.value;
    const selectedChatbotId = document.getElementById('chatbotSelector').value;
    if (selectedChatbotId) {
        updateCharts(selectedChatbotId, selectedDataType);
    }
});

// Initial setup to load data for the first chatbot and selected data type
document.addEventListener('DOMContentLoaded', () => {
    fetchChatbots();
    const initialChatbotId = document.getElementById('chatbotSelector').value;
    const initialDataType = document.getElementById('dataSelector').value;
    if (initialChatbotId) {
        updateCharts(initialChatbotId, initialDataType);
    }
});

        // Event listener for chart type selection
        document.getElementById('chartSelector').addEventListener('change', function () {
            const selectedChartType = this.value;

            // Hide all chart containers
            document.getElementById('barChartContainer').style.display = 'none';
            document.getElementById('lineChartContainer').style.display = 'none';
            document.getElementById('pieChartContainer').style.display = 'none';

            // Show the selected chart container
            if (selectedChartType === 'bar') {
                document.getElementById('barChartContainer').style.display = 'block';
            } else if (selectedChartType === 'line') {
                document.getElementById('lineChartContainer').style.display = 'block';
            } else if (selectedChartType === 'pie') {
                document.getElementById('pieChartContainer').style.display = 'block';
            }
        });

        // Initialize the page by fetching chatbots
        fetchChatbots();

        // Function to convert chart data to CSV format
function downloadCSV(chatbotName, chartType) {
    const data = chartType === 'bar' ? barChart.data.datasets[0].data :
                 chartType === 'line' ? lineChart.data.datasets[0].data :
                 pieChart.data.datasets[0].data;

    // Prepare CSV content
    const csvHeader = 'Rating,Count\n';
    const csvContent = ['Poor', 'Unsatisfied', 'Neutral', 'Satisfied', 'Excellent']
        .map((rating, index) => `${rating},${data[index]}`)
        .join('\n');

    const csvData = csvHeader + csvContent;

    // Create and trigger the download
    const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${chatbotName}_ratings.csv`;
    link.click();
}

// Access jsPDF from the UMD module
const { jsPDF } = window.jspdf;

// Function to generate and download the PDF report
async function downloadPDF(chatbotName, chartType) {
    const doc = new jsPDF();

    // Add title
    doc.setFontSize(18);
    doc.text(`Chatbot: ${chatbotName}`, 10, 10);

    // Add chart type
    doc.setFontSize(12);
    doc.text(`Chart Type: ${chartType}`, 10, 20);

    // Get the chart data
    let chartData;
    if (chartType === 'bar') {
        chartData = barChart;
    } else if (chartType === 'line') {
        chartData = lineChart;
    } else if (chartType === 'pie') {
        chartData = pieChart;
    }

    // Get the chart as an image (base64-encoded)
    const chartImage = chartData.toBase64Image();

    // Add the chart image to the PDF
    doc.addImage(chartImage, 'PNG', 10, 40, 180, 120);  // Adjust position and size as needed

    // Save the PDF
    doc.save(`${chatbotName}_report.pdf`);
}

// Event listener for the CSV download button
document.getElementById('downloadCsv').addEventListener('click', () => {
    const chatbotName = document.getElementById('chatbotSelector').selectedOptions[0].text;
    const chartType = document.getElementById('chartSelector').value;
    downloadCSV(chatbotName, chartType);
});

// Event listener for the PDF download button
document.getElementById('downloadPdf').addEventListener('click', () => {
    const chatbotName = document.getElementById('chatbotSelector').selectedOptions[0].text;
    const chartType = document.getElementById('chartSelector').value;
    downloadPDF(chatbotName, chartType);
});




    </script>
</body>
