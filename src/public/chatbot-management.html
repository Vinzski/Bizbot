<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot Management - BizBot Admin</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> 
</head>

<body>
  <div class="container">
    <aside class="sidebar">
      <h2>BizBot Admin</h2>
      <nav>
        <ul>
          <li><a href="dashboard.html">Dashboard</a></li>
          <li><a href="chatbot-management.html" class="active">Chatbot Management</a></li>
          <li><a href="training.html">Training Data</a></li>
          <li><a href="integration.html">Integration</a></li>
          <li><a href="settings.html">Settings</a></li>
          <li><a href="analytics.html">Analytics</a></li>
          <li><a href="support.html">Support</a></li>
          <li><button class="btn-logout" onclick="logout()" >Logout</button></li>
        </ul>
      </nav>
    </aside>
    <main class="main-content">
      <header class="dashboard-header">
        <h1>Chatbot Management</h1>
        <button>Create New Chatbot</button>
      </header>
      <div class="card">
        <h2>Existing Chatbots</h2>
        <table>
          <thead>
            <tr>
              <th>Chatbot Name</th>
              <th>Creation Date</th>
              <th>Modified Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dynamically added rows should appear here -->
          </tbody>
        </table>

      </div>
    </main>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      loadChatbots();
    });

    function loadChatbots() {
      const token = localStorage.getItem('token');
      if (!token) {
        console.log('No token found, redirecting to login.');
        window.location.href = 'index.html';
        return;
      }

      fetch('/api/chatbots', {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch chatbots');
          }
          return response.json();
        })
        .then(chatbots => {
          const tbody = document.querySelector('table tbody');
          tbody.innerHTML = ''; // Clear existing rows
          chatbots.forEach(chatbot => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${chatbot.name}</td>
              <td>${new Date(chatbot.createdAt).toLocaleString()}</td>
              <td>${new Date(chatbot.updatedAt).toLocaleString()}</td>
              <td><button onclick="editChatbot('${chatbot._id}')">Edit</button> 
              <button onclick="deleteChatbot('${chatbot._id}')">Delete</button>
            `;
            tbody.appendChild(row);
          });
        })
        .catch(error => {
          console.error('Error loading chatbots:', error);
          alert('Failed to load chatbots. Please try again.');
        });
    }

    async function editChatbot(chatbotId) {
      const token = localStorage.getItem('token');
      try {
        const response = await fetch(`/api/chatbots/${chatbotId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('Failed to fetch chatbot details');
        }

        const data = await response.json();

        // Navigate to training.html with chatbot and FAQ data in query parameters
        const chatbot = data.chatbot;
        const faqs = data.faqs.map(faq => faq._id).join(',');
        window.location.href = `training.html?chatbotId=${chatbotId}&faqs=${faqs}`;
      } catch (error) {
        console.error('Error fetching chatbot details:', error);
        alert('Failed to fetch chatbot details. Please try again.');
      }
    }

    function deleteChatbot(chatbotId) {
      const token = localStorage.getItem('token');
      console.log("Deleting chatbot with ID:", chatbotId);
      if (!confirm('Are you sure you want to delete this chatbot? This action will also delete its FAQs and cannot be undone.')) {
          return;
      }
  
      fetch(`/api/chatbots/${chatbotId}`, {
          method: 'DELETE',
          headers: {
              'Authorization': `Bearer ${token}`
          }
      })
          .then(response => {
              if (!response.ok) {
                  throw new Error('Failed to delete chatbot');
              }
              return response.json();
          })
          .then(() => {
              alert('Chatbot deleted successfully.');
              loadChatbots(); // Reload the chatbot list
          })
          .catch(error => {
              console.error('Error deleting chatbot:', error);
              alert('Failed to delete chatbot. Please try again.');
          });
  }
  
  </script>

</body>

</html>
